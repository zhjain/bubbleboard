<div class="h-screen w-screen overflow-hidden">
  <!-- Âçè‰ΩúÁôΩÊùøÂå∫Âüü -->
  <div x-data="whiteboard" class="w-full h-full bg-gray-50 relative">
    <!-- ÊÇ¨ÊµÆ‰∏ªÂ∑•ÂÖ∑Ê†è (È°∂ÈÉ®‰∏≠Èó¥) -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-50">
      <div class="bg-white/95 backdrop-blur-sm border border-gray-200 rounded-2xl shadow-lg px-3 py-2">
        <div class="flex items-center gap-1">
          <!-- Ê†∏ÂøÉÁªòÂà∂Â∑•ÂÖ∑ÁªÑ -->
          <template x-for="tool in tools" x-bind:key="tool.id">
            <button
              class="w-10 h-10 flex items-center justify-center rounded-xl text-lg text-gray-600 hover:bg-gray-100 hover:text-gray-800 transition-all duration-200"
              x-bind:class="currentTool === tool.id ? 'bg-blue-600 text-white shadow-sm' : ''"
              @click="selectTool(tool.id)"
              x-text="tool.icon"
              x-bind:title="tool.name">
            </button>
          </template>
          
          <!-- Â∑•ÂÖ∑ÂàÜÈöîÁ∫ø -->
          <div class="w-px h-6 bg-gray-300 mx-2"></div>
          
          <!-- ÂΩ¢Áä∂Â∑•ÂÖ∑ -->
          <button 
            class="w-10 h-10 flex items-center justify-center rounded-xl text-lg text-gray-600 hover:bg-gray-100 hover:text-gray-800 transition-all duration-200"
            x-bind:class="currentTool === 'shape' ? 'bg-blue-600 text-white shadow-sm' : ''"
            @click="selectTool('shape')"
            x-text="getShapeIcon()"
            title="ÂΩ¢Áä∂Â∑•ÂÖ∑">
          </button>
          
          <!-- ÂàÜÈöîÁ∫ø -->
          <div class="w-px h-6 bg-gray-300 mx-2"></div>
          
          <!-- Êìç‰ΩúÊéßÂà∂ÁªÑ -->
          <button
            class="w-10 h-10 flex items-center justify-center rounded-xl text-lg text-gray-600 hover:bg-gray-100 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
            @click="undo()"
            x-bind:disabled="!canUndo"
            title="Êí§ÈîÄ">
            ‚Ü∂
          </button>
          <button
            class="w-10 h-10 flex items-center justify-center rounded-xl text-lg text-gray-600 hover:bg-gray-100 transition-all duration-200"
            @click="clearCanvas()"
            title="Ê∏ÖÁ©∫ÁîªÂ∏É">
            üóëÔ∏è
          </button>
        </div>
      </div>
    </div>

    <!-- ÊÇ¨ÊµÆ‰∫åÁ∫ßÈÖçÁΩÆÂ∑•ÂÖ∑Ê†è (‰∏ªÂ∑•ÂÖ∑Ê†è‰∏ãÊñπ) -->
    <div 
      class="absolute top-20 left-1/2 transform -translate-x-1/2 z-40 transition-all duration-300"
      x-show="currentTool && showSecondaryToolbar"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-95 -translate-y-2"
      x-transition:enter-end="opacity-100 scale-100 translate-y-0"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 scale-100 translate-y-0"
      x-transition:leave-end="opacity-0 scale-95 -translate-y-2"
      x-cloak>
      <div class="bg-white/95 backdrop-blur-sm border border-gray-200 rounded-2xl shadow-lg px-4 py-3 min-w-96">
        <!-- ÂΩìÂâçÂ∑•ÂÖ∑ÈÖçÁΩÆÂå∫ -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <span class="text-sm font-medium text-gray-700" x-text="getCurrentToolName() + ' ËÆæÁΩÆ'"></span>
            
            <!-- Âä®ÊÄÅÈÖçÁΩÆÈ°π -->
            <template x-if="currentTool === 'pen'">
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-600">È¢úËâ≤</span>
                  <input type="color" x-model="globalConfig.color" class="w-8 h-8 rounded-lg border border-gray-300 cursor-pointer">
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-600">Á≤óÁªÜ</span>
                  <input type="range" x-model="globalConfig.size" min="1" max="50" class="w-24">
                  <span class="text-xs text-gray-500 w-10 text-center" x-text="globalConfig.size + 'px'"></span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-600">ÈÄèÊòéÂ∫¶</span>
                  <input type="range" x-model="globalConfig.opacity" min="0" max="100" class="w-20">
                  <span class="text-xs text-gray-500 w-10 text-center" x-text="globalConfig.opacity + '%'"></span>
                </div>
              </div>
            </template>

            <!-- ÈÄâÊã©Â∑•ÂÖ∑ÈÖçÁΩÆ -->
            <template x-if="currentTool === 'select'">
              <div class="flex items-center gap-4">
                <span class="text-sm text-gray-600">ÈÄâÊã©Â∑•ÂÖ∑ÔºöÁÇπÂáªÈÄâÊã©ÂÖÉÁ¥†ÔºåÊãñÊãΩÊ°ÜÈÄâÂ§ö‰∏™ÂÖÉÁ¥†</span>
                
                <!-- ÈÄâÊã©Êìç‰ΩúÊåâÈíÆ -->
                <div class="flex items-center gap-2">
                  <button class="text-xs px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors" @click="duplicateSelected()">
                    Â§çÂà∂ (Ctrl+D)
                  </button>
                  <button class="text-xs px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors" @click="deleteSelected()">
                    Âà†Èô§ (Del)
                  </button>
                  <button class="text-xs px-3 py-1.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors" @click="selectAll()">
                    ÂÖ®ÈÄâ (Ctrl+A)
                  </button>
                </div>
              </div>
            </template>

            <!-- Âπ≥ÁßªÂ∑•ÂÖ∑ÈÖçÁΩÆ -->
            <template x-if="currentTool === 'pan'">
              <div class="flex items-center gap-4">
                <span class="text-sm text-gray-600">Êó†ÈôêÁîªÂ∏ÉÔºöÊãñÊãΩÂπ≥ÁßªÔºåÊªöËΩÆÁº©Êîæ</span>
                
                <!-- Áº©ÊîæÊéßÂà∂ -->
                <div class="flex items-center gap-2">
                  <button class="text-xs px-2 py-1.5 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors" @click="zoomOut()" title="Áº©Â∞è (Ctrl+-)">
                    ‚àí
                  </button>
                  <span class="text-xs text-gray-600 w-12 text-center" x-text="getViewportInfo().zoomPercent"></span>
                  <button class="text-xs px-2 py-1.5 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors" @click="zoomIn()" title="ÊîæÂ§ß (Ctrl++)">
                    +
                  </button>
                </div>
                
                <!-- ËßÜÂõæÊìç‰ΩúÊåâÈíÆ -->
                <div class="flex items-center gap-2">
                  <button class="text-xs px-3 py-1.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors" @click="setZoom(1)" title="100% (Ctrl+1)">
                    100%
                  </button>
                  <button class="text-xs px-3 py-1.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors" @click="fitToScreen()" title="ÈÄÇÂ∫îÂÜÖÂÆπ">
                    ÈÄÇÂ∫î
                  </button>
                  <button class="text-xs px-3 py-1.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors" @click="resetView()" title="ÈáçÁΩÆËßÜÂõæ (Ctrl+0)">
                    ÈáçÁΩÆ
                  </button>
                </div>
              </div>
            </template>

            <!-- ÂΩ¢Áä∂Â∑•ÂÖ∑ÈÖçÁΩÆ -->
            <template x-if="currentTool === 'shape'">
              <div class="flex items-center gap-4">
                <!-- ÂΩ¢Áä∂Á±ªÂûãÈÄâÊã© -->
                <div class="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
                  <button 
                    class="w-8 h-8 flex items-center justify-center rounded text-sm transition-all duration-200"
                    x-bind:class="currentShapeType === 'rectangle' ? 'bg-white shadow-sm' : 'hover:bg-gray-200'"
                    @click="setShapeType('rectangle')"
                    title="Áü©ÂΩ¢">‚¨ú</button>
                  <button 
                    class="w-8 h-8 flex items-center justify-center rounded text-sm transition-all duration-200"
                    x-bind:class="currentShapeType === 'diamond' ? 'bg-white shadow-sm' : 'hover:bg-gray-200'"
                    @click="setShapeType('diamond')"
                    title="Ëè±ÂΩ¢">‚óá</button>
                  <button 
                    class="w-8 h-8 flex items-center justify-center rounded text-sm transition-all duration-200"
                    x-bind:class="currentShapeType === 'parallelogram' ? 'bg-white shadow-sm' : 'hover:bg-gray-200'"
                    @click="setShapeType('parallelogram')"
                    title="Âπ≥Ë°åÂõõËæπÂΩ¢">‚ñ±</button>
                  <button 
                    class="w-8 h-8 flex items-center justify-center rounded text-sm transition-all duration-200"
                    x-bind:class="currentShapeType === 'circle' ? 'bg-white shadow-sm' : 'hover:bg-gray-200'"
                    @click="setShapeType('circle')"
                    title="ÂúÜÂΩ¢">‚≠ï</button>
                  <button 
                    class="w-8 h-8 flex items-center justify-center rounded text-sm transition-all duration-200"
                    x-bind:class="currentShapeType === 'ellipse' ? 'bg-white shadow-sm' : 'hover:bg-gray-200'"
                    @click="setShapeType('ellipse')"
                    title="Ê§≠ÂúÜ">‚≠ï</button>
                </div>
                
                <!-- Âü∫Á°ÄÈÖçÁΩÆ -->
                <div class="flex items-center gap-3">
                  <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-600">Â°´ÂÖÖ</span>
                    <input type="color" x-model="globalConfig.fill" class="w-8 h-8 rounded-lg border border-gray-300 cursor-pointer">
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-600">ËæπÊ°Ü</span>
                    <input type="color" x-model="globalConfig.stroke" class="w-8 h-8 rounded-lg border border-gray-300 cursor-pointer">
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-600">Á≤óÁªÜ</span>
                    <input type="range" x-model="globalConfig.strokeWidth" min="0" max="20" class="w-20">
                    <span class="text-xs text-gray-500 w-8 text-center" x-text="globalConfig.strokeWidth + 'px'"></span>
                  </div>
                  
                  <!-- Âä®ÊÄÅÁâπÊÆäÈÖçÁΩÆ -->
                  <template x-if="currentShapeType === 'rectangle'">
                    <div class="flex items-center gap-2">
                      <span class="text-xs text-gray-600">ÂúÜËßí</span>
                      <input type="range" x-model="globalConfig.cornerRadius" min="0" max="50" class="w-20">
                      <span class="text-xs text-gray-500 w-8 text-center" x-text="globalConfig.cornerRadius + 'px'"></span>
                    </div>
                  </template>
                  
                  <template x-if="currentShapeType === 'diamond'">
                    <div class="flex items-center gap-2">
                      <span class="text-xs text-gray-600">ÊóãËΩ¨</span>
                      <input type="range" x-model="globalConfig.rotation" min="0" max="360" class="w-20">
                      <span class="text-xs text-gray-500 w-8 text-center" x-text="globalConfig.rotation + '¬∞'"></span>
                    </div>
                  </template>
                  
                  <template x-if="currentShapeType === 'parallelogram'">
                    <div class="flex items-center gap-2">
                      <span class="text-xs text-gray-600">ÂÄæÊñú</span>
                      <input type="range" x-model="globalConfig.skewAngle" min="-45" max="45" class="w-20">
                      <span class="text-xs text-gray-500 w-8 text-center" x-text="globalConfig.skewAngle + '¬∞'"></span>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>

          <!-- ÈÖçÁΩÆÊìç‰ΩúÊåâÈíÆ -->
          <div class="flex items-center gap-2">
            <button class="text-xs px-3 py-1.5 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors" @click="showSecondaryToolbar = false">
              Êî∂Ëµ∑
            </button>
            <button class="text-xs px-3 py-1.5 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-colors">
              Êõ¥Â§ö
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ÁîªÂ∏ÉÂå∫Âüü -->
    <div class="absolute inset-0 overflow-hidden">
      <canvas
        id="whiteboard"
        x-ref="canvas"
        @mousedown="handleStart($event)"
        @mousemove="handleMove($event)"
        @mouseup="handleEnd($event)"
        @touchstart="handleStart($event)"
        @touchmove="handleMove($event)"
        @touchend="handleEnd($event)"
        class="w-full h-full bg-white cursor-crosshair"
        x-bind:style="{ cursor: getCurrentToolCursor() }">
      </canvas>
      
      <!-- ÁîªÂ∏ÉÁä∂ÊÄÅÊåáÁ§∫Âô® -->
      <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur-sm rounded-xl px-3 py-2 shadow-lg border border-gray-200">
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          <span>ÂΩìÂâçÂ∑•ÂÖ∑:</span>
          <span class="font-medium text-gray-800" x-text="getCurrentToolName()"></span>
        </div>
      </div>

      <!-- Âè≥‰∏ãËßíËßÜÂõæÊéßÂà∂ -->
      <div class="absolute bottom-4 right-4 flex flex-col gap-2">
        <button class="w-10 h-10 bg-white/90 backdrop-blur-sm border border-gray-200 rounded-xl shadow-lg flex items-center justify-center text-gray-600 hover:text-gray-800 hover:bg-white transition-all duration-200" title="Áº©Êîæ">
          üîç
        </button>
        <button class="w-10 h-10 bg-white/90 backdrop-blur-sm border border-gray-200 rounded-xl shadow-lg flex items-center justify-center text-gray-600 hover:text-gray-800 hover:bg-white transition-all duration-200" title="ÂàÜ‰∫´">
          üì§
        </button>
      </div>
    </div>
  </div>

  <!-- ËÅäÂ§©ÂÆ§Âå∫Âüü -->
  <div x-data="chat" class="fixed bottom-4 right-4 flex flex-col items-end">
    <div
      x-show="showChat"
      x-cloak
      x-transition:enter="transition-all duration-300"
      x-transition:enter-start="opacity-0 scale-0 translate-x-40 translate-y-48 rounded-full"
      x-transition:enter-end="opacity-100 scale-100 translate-x-0 translate-y-0 rounded-lg"
      x-transition:leave="transition-all duration-300"
      x-transition:leave-start="opacity-100 scale-100 translate-x-0 translate-y-0 rounded-lg"
      x-transition:leave-end="opacity-0 scale-0 translate-x-40 translate-y-48 rounded-full"
      class="absolute bottom-0 right-0 w-80 h-96 bg-white rounded-lg shadow-lg flex flex-col">
      <!-- ËÅäÂ§©ÂÆ§Â§¥ÈÉ® -->
      <div
        class="bg-blue-600 text-white px-4 py-4 rounded-t-lg flex justify-between items-center select-none">
        <h2 class="header-info text-lg font-semibold">ËÅäÂ§©ÂÆ§</h2>
        <div class="flex items-center gap-4">
          <div class="header-info text-sm opacity-90 select-none">
            Âú®Á∫ø‰∫∫Êï∞: <span x-text="online_count"></span>
          </div>
          <button
            @click="showChat = false"
            type="button"
            class="text-white hover:text-gray-200 focus:outline-none flex my-auto">
            <.icon name="hero-minus" class="inline-block w-4 h-4" />
          </button>
        </div>
      </div>

      <!-- Ê∂àÊÅØÊòæÁ§∫Âå∫Âüü -->
      <div
        x-ref="messageContainer"
        x-bind:style="{ opacity: loaded ? 1 : 0, transition: 'opacity 0.3s ease' }"
        class="flex-1 bg-gray-50 overflow-y-auto p-4">
        <div class="space-y-3">
          <!-- Ê∂àÊÅØÂ∞ÜÈÄöËøá JS Âä®ÊÄÅÊ∑ªÂä†Âà∞ËøôÈáå -->
          <template x-for="message in messages" x-bind:key="message.timestamp">
            <div class="bg-white p-3 rounded-lg shadow-sm">
              <div class="flex items-center justify-between mb-1">
                <span
                  class="text-sm font-medium text-gray-800 bg-gray-200 px-1 rounded-lg"
                  x-text="message.user || 'ÂåøÂêç'">
                </span>
                <span
                  class="text-xs text-gray-500"
                  x-text="new Date(message.timestamp).toLocaleTimeString()">
                </span>
              </div>
              <p class="text-sm pl-1 text-gray-700" x-text="message.body"></p>
            </div>
          </template>
        </div>
      </div>

      <!-- ËæìÂÖ•Âå∫Âüü -->
      <div id="chat-input" class="border-t bg-white p-4 rounded-b-lg">
        <!-- Áî®Êà∑ÂêçÊòæÁ§∫ -->
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">ÂΩìÂâçÁî®Êà∑:</span>
            <span x-text="username" class="text-sm font-medium text-gray-800">
              ÂåøÂêç
            </span>
          </div>
          <div class="flex gap-2">
            <button
              @click="handleShowEditUser"
              type="button"
              class="text-xs px-3 py-1 text-blue-600 border border-blue-300 rounded hover:bg-blue-50 transition-colors">
              <.icon name="hero-pencil-square" class="inline-block w-4 h-4" />
            </button>
            <button
              @click="handleClearUsername"
              type="button"
              class="text-xs px-3 py-1 text-red-600 border border-red-300 rounded hover:bg-red-50 transition-colors">
              <.icon name="hero-trash" class="inline-block w-4 h-4" />
            </button>
          </div>
        </div>

        <!-- Ê∂àÊÅØËæìÂÖ• -->
        <form @submit="handleSubmit" class="flex gap-3">
          <input
            type="text"
            x-model="input"
            placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
            maxlength="500"
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <button
            id="send-button"
            type="submit"
            class="px-3 py-2 flex bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <.icon name="hero-paper-airplane" class="inline-block m-auto w-4
            h-4" />
          </button>
        </form>
      </div>
    </div>

    <!-- Áº©Â∞èÂêéÁöÑÂúÜÂΩ¢ÊåâÈíÆ -->
    <button
      x-show="!showChat"
      @click="showChat = true"
      x-transition:enter="transition-all duration-300"
      x-transition:enter-start="opacity-0 scale-0"
      x-transition:enter-end="opacity-100 scale-100"
      x-transition:leave="transition-all duration-300"
      x-transition:leave-start="opacity-100 scale-100"
      x-transition:leave-end="opacity-0 scale-0"
      class="absolute bottom-0 right-0 w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-blue-700">
      <.icon name="hero-chat-bubble-left-right" class="w-5 h-5" />
    </button>

    <!-- Áî®Êà∑ÂêçËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div
      x-show="showEditUser"
      x-cloak
      @click="e => hideEditUser(e, $el)"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 w-80 mx-4">
        <h3 class="text-lg font-semibold mb-4">ËÆæÁΩÆÁî®Êà∑Âêç</h3>
        <input
          x-ref="usernameInput"
          type="text"
          x-model="newUsername"
          placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç"
          maxlength="20"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <button
          @click="handleSave"
          type="button"
          class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          ‰øùÂ≠ò
        </button>
      </div>
    </div>
  </div>
</div>
