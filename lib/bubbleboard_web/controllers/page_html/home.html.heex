<div class="h-screen w-screen overflow-hidden">
  <!-- Âçè‰ΩúÁôΩÊùøÂå∫Âüü -->
  <div x-data="whiteboard" class="w-full h-full bg-gray-100">
    <!-- Â∑•ÂÖ∑Ê†è -->
    <div
      class="fixed top-4 left-4 z-50 flex flex-col gap-2 bg-white p-4 rounded-lg shadow-lg w-48">
      <label class="text-gray-700 font-semibold mb-2">Â∑•ÂÖ∑</label>

      <template x-for="tool in tools" x-bind:key="tool.id">
        <button
          class="w-full px-3 py-2 rounded border transition-colors text-gray-700 border-gray-300 hover:bg-gray-100"
          x-bind:class="currentTool === tool.id ? 'bg-blue-500 text-white border-blue-500' : ''"
          @click="selectTool(tool.id)"
          x-text="tool.icon + ' ' + tool.name"></button>
      </template>
    </div>

    <!-- ÂΩìÂâçÂ∑•ÂÖ∑ÁöÑÁâπÊÆäÈÖçÁΩÆ -->
    <div
      class="fixed top-4 left-60 z-50 flex flex-col gap-2 bg-white p-4 rounded-lg shadow-lg w-64"
      x-show="currentToolConfig.length > 0">
      <label class="text-gray-700 font-semibold mb-2">ÈÄâÈ°π</label>

      <template x-for="config in currentToolConfig" x-bind:key="config.key">
        <!-- ‰∏ãÊãâÈÄâÊã© -->
        <div x-show="config.type === 'select'" class="mb-2">
          <select
            x-model="globalConfig[config.key]"
            class="w-full px-3 py-2 border border-gray-300 rounded text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
            <template
              x-for="option in config.options"
              x-bind:key="option.value">
              <option
                x-bind:value="option.value"
                x-text="option.label"></option>
            </template>
          </select>
        </div>

        <!-- ÂºÄÂÖ≥ÊåâÈíÆ -->
        <div x-show="config.type === 'toggle'" class="mb-2">
          <button
            class="w-full px-3 py-2 rounded transition-colors"
            x-bind:class="globalConfig[config.key] ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'"
            @click="globalConfig[config.key] = !globalConfig[config.key]"
            x-text="config.label + ': ' + (globalConfig[config.key] ? 'ÂºÄ' : 'ÂÖ≥')"></button>
        </div>
      </template>
    </div>

    <!-- Êìç‰ΩúÊåâÈíÆ -->
    <div class="fixed top-80 left-4 z-50 flex flex-col gap-2 w-48">
      <button
        class="w-full px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
        @click="clearCanvas()">
        üóëÔ∏è Ê∏ÖÁ©∫
      </button>

      <button
        class="w-full px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        @click="undo()"
        x-bind:disabled="!canUndo">
        ‚Ü∂ Êí§ÈîÄ
      </button>
    </div>

    <canvas
      id="whiteboard"
      x-ref="canvas"
      @mousedown="handleStart($event)"
      @mousemove="handleMove($event)"
      @mouseup="handleEnd($event)"
      @touchstart="handleStart($event)"
      @touchmove="handleMove($event)"
      @touchend="handleEnd($event)"
      class="w-full h-full bg-white border border-gray-300"></canvas>
  </div>

  <!-- ËÅäÂ§©ÂÆ§Âå∫Âüü -->
  <div x-data="chat" class="fixed bottom-4 right-4 flex flex-col items-end">
    <div
      x-show="showChat"
      x-transition:enter="transition-all duration-300"
      x-transition:enter-start="opacity-0 scale-0 translate-x-40 translate-y-48 rounded-full"
      x-transition:enter-end="opacity-100 scale-100 translate-x-0 translate-y-0 rounded-lg"
      x-transition:leave="transition-all duration-300"
      x-transition:leave-start="opacity-100 scale-100 translate-x-0 translate-y-0 rounded-lg"
      x-transition:leave-end="opacity-0 scale-0 translate-x-40 translate-y-48 rounded-full"
      class="absolute bottom-0 right-0 w-80 h-96 bg-white rounded-lg shadow-lg flex flex-col">
      <!-- ËÅäÂ§©ÂÆ§Â§¥ÈÉ® -->
      <div
        class="bg-blue-600 text-white px-4 py-4 rounded-t-lg flex justify-between items-center select-none">
        <h2 class="header-info text-lg font-semibold">ËÅäÂ§©ÂÆ§</h2>
        <div class="flex items-center gap-4">
          <div class="header-info text-sm opacity-90 select-none">
            Âú®Á∫ø‰∫∫Êï∞: <span x-text="online_count"></span>
          </div>
          <button
            @click="showChat = false"
            type="button"
            class="text-white hover:text-gray-200 focus:outline-none flex my-auto">
            <.icon name="hero-minus" class="inline-block w-4 h-4" />
          </button>
        </div>
      </div>

      <!-- Ê∂àÊÅØÊòæÁ§∫Âå∫Âüü -->
      <div
        x-ref="messageContainer"
        x-bind:style="{ opacity: loaded ? 1 : 0, transition: 'opacity 0.3s ease' }"
        class="flex-1 bg-gray-50 overflow-y-auto p-4">
        <div class="space-y-3">
          <!-- Ê∂àÊÅØÂ∞ÜÈÄöËøá JS Âä®ÊÄÅÊ∑ªÂä†Âà∞ËøôÈáå -->
          <template x-for="message in messages" x-bind:key="message.timestamp">
            <div class="bg-white p-3 rounded-lg shadow-sm">
              <div class="flex items-center justify-between mb-1">
                <span
                  class="text-sm font-medium text-gray-800 bg-gray-200 px-1 rounded-lg"
                  x-text="message.user || 'ÂåøÂêç'">
                </span>
                <span
                  class="text-xs text-gray-500"
                  x-text="new Date(message.timestamp).toLocaleTimeString()">
                </span>
              </div>
              <p class="text-sm pl-1 text-gray-700" x-text="message.body"></p>
            </div>
          </template>
        </div>
      </div>

      <!-- ËæìÂÖ•Âå∫Âüü -->
      <div id="chat-input" class="border-t bg-white p-4 rounded-b-lg">
        <!-- Áî®Êà∑ÂêçÊòæÁ§∫ -->
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">ÂΩìÂâçÁî®Êà∑:</span>
            <span x-text="username" class="text-sm font-medium text-gray-800">
              ÂåøÂêç
            </span>
          </div>
          <div class="flex gap-2">
            <button
              @click="handleShowEditUser"
              type="button"
              class="text-xs px-3 py-1 text-blue-600 border border-blue-300 rounded hover:bg-blue-50 transition-colors">
              <.icon name="hero-pencil-square" class="inline-block w-4 h-4" />
            </button>
            <button
              @click="handleClearUsername"
              type="button"
              class="text-xs px-3 py-1 text-red-600 border border-red-300 rounded hover:bg-red-50 transition-colors">
              <.icon name="hero-trash" class="inline-block w-4 h-4" />
            </button>
          </div>
        </div>

        <!-- Ê∂àÊÅØËæìÂÖ• -->
        <form @submit="handleSubmit" class="flex gap-3">
          <input
            type="text"
            x-model="input"
            placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
            maxlength="500"
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <button
            id="send-button"
            type="submit"
            class="px-3 py-2 flex bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <.icon name="hero-paper-airplane" class="inline-block m-auto w-4
            h-4" />
          </button>
        </form>
      </div>
    </div>

    <!-- Áº©Â∞èÂêéÁöÑÂúÜÂΩ¢ÊåâÈíÆ -->
    <button
      x-show="!showChat"
      @click="showChat = true"
      x-transition:enter="transition-all duration-300"
      x-transition:enter-start="opacity-0 scale-0"
      x-transition:enter-end="opacity-100 scale-100"
      x-transition:leave="transition-all duration-300"
      x-transition:leave-start="opacity-100 scale-100"
      x-transition:leave-end="opacity-0 scale-0"
      class="absolute bottom-0 right-0 w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-blue-700">
      <.icon name="hero-chat-bubble-left-right" class="w-5 h-5" />
    </button>

    <!-- Áî®Êà∑ÂêçËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
    <div
      x-show="showEditUser"
      x-cloak
      @click="e => hideEditUser(e, $el)"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
      <div class="bg-white rounded-lg p-6 w-80 mx-4">
        <h3 class="text-lg font-semibold mb-4">ËÆæÁΩÆÁî®Êà∑Âêç</h3>
        <input
          x-ref="usernameInput"
          type="text"
          x-model="newUsername"
          placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç"
          maxlength="20"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <button
          @click="handleSave"
          type="button"
          class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          ‰øùÂ≠ò
        </button>
      </div>
    </div>
  </div>
</div>
